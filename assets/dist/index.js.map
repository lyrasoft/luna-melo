{"version":3,"file":"index.js","sources":["../src/features/lesson/useLessonCartButtons.ts","../src/features/section/useSectionEditComponents.ts","../src/features/question/useQuestionEditComponents.ts","../src/index.ts"],"sourcesContent":["import { ApiReturn, delegate, route, simpleAlert, useHttpClient, useUnicorn } from '@windwalker-io/unicorn-next';\nimport { CartItem } from '~melo/types';\n\nexport function useLessonCartButtons(selector = '[data-melo-task=buy]', quantitySelector = '') {\n  listen(selector);\n\n  return {\n    off,\n    buy,\n    toCartPage,\n    sendAddAction,\n  };\n}\n\nlet isListening = false;\n\nfunction buttonClicked(e: Event)  {\n  buy(e.currentTarget as HTMLElement);\n}\n\nfunction listen(selector = '[data-melo-task=buy]') {\n  if (isListening) {\n    return;\n  }\n\n  isListening = true;\n\n  delegate(document.body, selector, 'click', buttonClicked);\n}\n\nfunction off() {\n  document.body.removeEventListener('click', buttonClicked);\n\n  isListening = false;\n}\n\nasync function sendAddAction(el: HTMLElement) {\n  const lessonId = el.dataset.id;\n\n  if (!lessonId) {\n    throw new Error('No lesson ID');\n  }\n\n  const { post } = await useHttpClient();\n\n  try {\n    const res = await post<ApiReturn<CartItem[]>>(\n      '@melo_cart_ajax/addToCart',\n      {\n        id: lessonId,\n      }\n    );\n\n    updateCartButton(res.data.data);\n\n    return res.data.data;\n  } catch (e) {\n    console.error(e);\n    throw e;\n  }\n}\n\nasync function buy(el: HTMLElement) {\n  const { isAxiosError } = await useHttpClient();\n\n  try {\n    await sendAddAction(el);\n  } catch (e) {\n    if (isAxiosError(e)) {\n      simpleAlert(e.message, '', 'warning');\n    }\n    return;\n  }\n\n  toCartPage();\n}\n\nfunction toCartPage() {\n  location.href = route('melo_cart');\n}\n\nfunction updateCartButton(items: CartItem[]) {\n  const count = items.length;\n\n  const u = useUnicorn();\n\n  u.trigger('melo.cart.update', items, count);\n\n  document.dispatchEvent(\n    new CustomEvent('melo.cart.update', {\n      detail: {\n        items,\n        count\n      }\n    })\n  );\n\n  const $cartButtons = document.querySelectorAll<HTMLButtonElement>('[data-melo-role=cart-button]');\n\n  for (const $cartButton of $cartButtons) {\n    const $cartQuantity = $cartButton.querySelector<HTMLDivElement>('[data-melo-role=cart-quantity]');\n\n    $cartButton.classList.toggle('h-has-items', count > 0);\n\n    if ($cartQuantity) {\n      $cartQuantity.textContent = String(count);\n    }\n\n    $cartButton.dispatchEvent(\n      new CustomEvent('melo.cart.update', {\n        detail: {\n          items,\n          count\n        }\n      })\n    );\n  }\n}\n","\ntype ModuleImportCallback = () => Promise<any>;\n\nconst sectionEditComponents: Record<string, ModuleImportCallback> = {\n  video: () => import('~melo/components/segment-edit/section/SectionVideoEdit.vue'),\n  homework: () => import('~melo/components/segment-edit/section/SectionHomeworkEdit.vue'),\n  quiz: () => import('~melo/components/segment-edit/section/SectionQuizEdit.vue'),\n}\n\nexport function useSectionEditComponents(): Record<string, ModuleImportCallback>;\nexport function useSectionEditComponents(id: string, component: ModuleImportCallback): Record<string, ModuleImportCallback>;\nexport function useSectionEditComponents(id: Record<string, ModuleImportCallback>): Record<string, ModuleImportCallback>;\nexport function useSectionEditComponents(id?: string | Record<string, ModuleImportCallback>, component?: ModuleImportCallback) {\n  if (typeof id === 'object') {\n    Object.assign(sectionEditComponents, id);\n  } else if (component && typeof id === 'string') {\n    sectionEditComponents[id] = component;\n  }\n\n  return sectionEditComponents;\n}\n\n","\ntype ModuleImportCallback = () => Promise<any>;\n\nconst questionEditComponents: Record<string, ModuleImportCallback> = {\n  boolean: () => import('~melo/components/segment-edit/question/QuestionEdit.vue'),\n  select: () => import('~melo/components/segment-edit/question/QuestionEdit.vue'),\n  multiple: () => import('~melo/components/segment-edit/question/QuestionEdit.vue'),\n}\n\nexport function useQuestionEditComponents(): Record<string, ModuleImportCallback>;\nexport function useQuestionEditComponents(id: string, component: ModuleImportCallback): Record<string, ModuleImportCallback>;\nexport function useQuestionEditComponents(id: Record<string, ModuleImportCallback>): Record<string, ModuleImportCallback>;\nexport function useQuestionEditComponents(id?: string | Record<string, ModuleImportCallback>, component?: ModuleImportCallback) {\n  if (typeof id === 'object') {\n    Object.assign(questionEditComponents, id);\n  } else if (component && typeof id === 'string') {\n    questionEditComponents[id] = component;\n  }\n\n  return questionEditComponents;\n}\n\n","import { useMacro } from '@windwalker-io/unicorn-next';\nimport { useLessonCartButtons } from '~melo/features/lesson/useLessonCartButtons';\n\nexport * from '~melo/features/lesson/useLessonCartButtons';\nexport * from '~melo/features/section/useSectionEditComponents';\nexport * from '~melo/features/question/useQuestionEditComponents';\nexport * from '~melo/types';\n\nexport function useMeloFrontLessons() {\n  return useMacro('$melo', {\n    useLessonCartButtons,\n  });\n}\n\nexport async function createSegmentEditorApp(props: Record<string, any>) {\n  const { createSegmentEditorApp } = await import('~melo/segment-editor');\n\n  return createSegmentEditorApp(props);\n}\n\nexport async function createMeloCartApp(props: Record<string, any>) {\n  const { createMeloCartApp } = await import('~melo/melo-cart');\n\n  return createMeloCartApp(props);\n}\n"],"names":["createSegmentEditorApp","createMeloCartApp"],"mappings":"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"}