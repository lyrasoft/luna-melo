{"version":3,"file":"useFileUploader.js","sources":["../../src/features/file/useFileUploader.ts"],"sourcesContent":["import { ApiReturn, data, useHttpClient, useS3MultipartUploader } from '@windwalker-io/unicorn-next';\r\nimport { computed, MaybeRefOrGetter, toRef } from 'vue';\r\n\r\nexport interface FileUploaderOptions {\r\n  onProgress?: (progress: number) => void;\r\n  accept?: MaybeRefOrGetter<string | string[] | undefined>;\r\n}\r\n\r\nexport interface FileUploadOptions {\r\n  onProgress?: (progress: number) => void;\r\n}\r\n\r\nexport function useFileUploader(uploaderOptions: FileUploaderOptions = {}) {\r\n  const accept = toRef(uploaderOptions.accept);\r\n\r\n  function wrapClassicUpload(\r\n    uploadUrl: string,\r\n    options?: FileUploadOptions\r\n  ) {\r\n    return async (file: File, dest?: string) => {\r\n      return classicUpload(uploadUrl, file, dest, options);\r\n    };\r\n  }\r\n\r\n  async function classicUpload(\r\n    uploadUrl: string,\r\n    file: File,\r\n    dest?: string,\r\n    options?: FileUploadOptions\r\n  ) {\r\n    const { post } = await useHttpClient();\r\n\r\n    const formData = new FormData();\r\n    formData.append('file', file);\r\n\r\n    if (dest) {\r\n      formData.append('path', dest);\r\n    }\r\n\r\n    const onProgress = options?.onProgress ?? uploaderOptions.onProgress;\r\n\r\n    const res = await post<ApiReturn<{ url: string }>>(uploadUrl, formData, {\r\n      onUploadProgress: (progressEvent) => {\r\n        if (progressEvent.total) {\r\n          const percentage = Math.round((progressEvent.loaded * 100) / progressEvent.total);\r\n          onProgress?.(percentage);\r\n        }\r\n      }\r\n    });\r\n\r\n    return res.data.data.url;\r\n  }\r\n\r\n  async function s3MultiPartUpload(file: File, dest: string, options?: FileUploadOptions) {\r\n    const onProgress = options?.onProgress ?? uploaderOptions.onProgress;\r\n\r\n    const profile = data('video.upload.profile');\r\n    const s3 = await useS3MultipartUploader({\r\n      profile,\r\n      routes: (action) => {\r\n        return `@ajax_segment/${action}`;\r\n      },\r\n      onProgress: (e) => {\r\n        onProgress?.(e.percentage);\r\n      }\r\n    });\r\n\r\n    const { url } = await s3.upload(file, dest);\r\n\r\n    // Fix Unicorn bug\r\n    return url.replace(/%2F/g, '/');\r\n  }\r\n\r\n  const acceptString = computed(() => {\r\n    if (Array.isArray(accept.value)) {\r\n      return accept.value.join(',');\r\n    }\r\n\r\n    return accept.value;\r\n  });\r\n\r\n  const acceptList = computed(() => {\r\n    if (Array.isArray(accept.value)) {\r\n      return accept.value;\r\n    }\r\n\r\n    return accept.value?.split(',').map(item => item.trim()) || [];\r\n  });\r\n\r\n  function checkFileType(file: File) {\r\n    if (acceptList.value.length === 0) {\r\n      return true;\r\n    }\r\n\r\n    return acceptList.value.some((accept) => {\r\n      if (accept.startsWith('.')) {\r\n        return file.name.endsWith(accept);\r\n      } else {\r\n        const regex = new RegExp('^' + accept.replace('*', '.*') + '$');\r\n        return regex.test(file.type);\r\n      }\r\n    });\r\n  }\r\n\r\n  return {\r\n    classicUpload,\r\n    wrapClassicUpload,\r\n    s3MultiPartUpload,\r\n    acceptString,\r\n    acceptList,\r\n    checkFileType,\r\n  };\r\n}\r\n\r\n"],"names":["accept"],"mappings":";;AAYO,SAAS,gBAAgB,kBAAuC,IAAI;AACzE,QAAM,SAAS,MAAM,gBAAgB,MAAM;AAE3C,WAAS,kBACP,WACA,SACA;AACA,WAAO,OAAO,MAAY,SAAkB;AAC1C,aAAO,cAAc,WAAW,MAAM,MAAM,OAAO;AAAA,IACrD;AAAA,EACF;AAEA,iBAAe,cACb,WACA,MACA,MACA,SACA;AACA,UAAM,EAAE,SAAS,MAAM,cAAA;AAEvB,UAAM,WAAW,IAAI,SAAA;AACrB,aAAS,OAAO,QAAQ,IAAI;AAE5B,QAAI,MAAM;AACR,eAAS,OAAO,QAAQ,IAAI;AAAA,IAC9B;AAEA,UAAM,aAAa,SAAS,cAAc,gBAAgB;AAE1D,UAAM,MAAM,MAAM,KAAiC,WAAW,UAAU;AAAA,MACtE,kBAAkB,CAAC,kBAAkB;AACnC,YAAI,cAAc,OAAO;AACvB,gBAAM,aAAa,KAAK,MAAO,cAAc,SAAS,MAAO,cAAc,KAAK;AAChF,uBAAa,UAAU;AAAA,QACzB;AAAA,MACF;AAAA,IAAA,CACD;AAED,WAAO,IAAI,KAAK,KAAK;AAAA,EACvB;AAEA,iBAAe,kBAAkB,MAAY,MAAc,SAA6B;AACtF,UAAM,aAAa,SAAS,cAAc,gBAAgB;AAE1D,UAAM,UAAU,KAAK,sBAAsB;AAC3C,UAAM,KAAK,MAAM,uBAAuB;AAAA,MACtC;AAAA,MACA,QAAQ,CAAC,WAAW;AAClB,eAAO,iBAAiB,MAAM;AAAA,MAChC;AAAA,MACA,YAAY,CAAC,MAAM;AACjB,qBAAa,EAAE,UAAU;AAAA,MAC3B;AAAA,IAAA,CACD;AAED,UAAM,EAAE,IAAA,IAAQ,MAAM,GAAG,OAAO,MAAM,IAAI;AAG1C,WAAO,IAAI,QAAQ,QAAQ,GAAG;AAAA,EAChC;AAEA,QAAM,eAAe,SAAS,MAAM;AAClC,QAAI,MAAM,QAAQ,OAAO,KAAK,GAAG;AAC/B,aAAO,OAAO,MAAM,KAAK,GAAG;AAAA,IAC9B;AAEA,WAAO,OAAO;AAAA,EAChB,CAAC;AAED,QAAM,aAAa,SAAS,MAAM;AAChC,QAAI,MAAM,QAAQ,OAAO,KAAK,GAAG;AAC/B,aAAO,OAAO;AAAA,IAChB;AAEA,WAAO,OAAO,OAAO,MAAM,GAAG,EAAE,IAAI,CAAA,SAAQ,KAAK,KAAA,CAAM,KAAK,CAAA;AAAA,EAC9D,CAAC;AAED,WAAS,cAAc,MAAY;AACjC,QAAI,WAAW,MAAM,WAAW,GAAG;AACjC,aAAO;AAAA,IACT;AAEA,WAAO,WAAW,MAAM,KAAK,CAACA,YAAW;AACvC,UAAIA,QAAO,WAAW,GAAG,GAAG;AAC1B,eAAO,KAAK,KAAK,SAASA,OAAM;AAAA,MAClC,OAAO;AACL,cAAM,QAAQ,IAAI,OAAO,MAAMA,QAAO,QAAQ,KAAK,IAAI,IAAI,GAAG;AAC9D,eAAO,MAAM,KAAK,KAAK,IAAI;AAAA,MAC7B;AAAA,IACF,CAAC;AAAA,EACH;AAEA,SAAO;AAAA,IACL;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EAAA;AAEJ;"}