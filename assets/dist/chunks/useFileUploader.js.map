{"version":3,"file":"useFileUploader.js","sources":["../../src/modules/segment-editor/features/file/useFileUploader.ts"],"sourcesContent":["import { ApiReturn, data, useHttpClient, useS3MultipartUploader } from '@windwalker-io/unicorn-next';\nimport { computed, MaybeRefOrGetter, toRef } from 'vue';\n\nexport interface FileUploaderOptions {\n  onProgress?: (progress: number) => void;\n  accept?: MaybeRefOrGetter<string | string[] | undefined>;\n}\n\nexport interface FileUploadOptions {\n  onProgress?: (progress: number) => void;\n}\n\nlet abortController: AbortController | null = null;\n\nexport function useFileUploader(uploaderOptions: FileUploaderOptions = {}) {\n  const accept = toRef(uploaderOptions.accept);\n\n  function wrapClassicUpload(\n    uploadUrl: string,\n    options?: FileUploadOptions\n  ) {\n    return async (file: File, dest?: string) => {\n      return classicUpload(uploadUrl, file, dest, options);\n    };\n  }\n\n  async function classicUpload(\n    uploadUrl: string,\n    file: File,\n    dest?: string,\n    options?: FileUploadOptions\n  ) {\n    const { post } = await useHttpClient();\n\n    const formData = new FormData();\n    formData.append('file', file);\n\n    if (dest) {\n      formData.append('path', dest);\n    }\n\n    const onProgress = options?.onProgress ?? uploaderOptions.onProgress;\n    abortController = new AbortController();\n\n    const res = await post<ApiReturn<{ url: string }>>(uploadUrl, formData, {\n      signal: abortController.signal,\n      onUploadProgress: (progressEvent) => {\n        if (progressEvent.total) {\n          const percentage = Math.round((progressEvent.loaded * 100) / progressEvent.total);\n          onProgress?.(percentage);\n        }\n      }\n    });\n\n    return res.data.data.url;\n  }\n\n  async function s3MultiPartUpload(file: File, dest: string, options?: FileUploadOptions) {\n    const onProgress = options?.onProgress ?? uploaderOptions.onProgress;\n\n    const profile = data('video.upload.profile');\n    const s3 = await useS3MultipartUploader({\n      profile,\n      routes: (action) => {\n        return `@ajax_segment/${action}`;\n      },\n      onProgress: (e) => {\n        onProgress?.(e.percentage);\n      }\n    });\n\n    abortController = new AbortController();\n\n    const promise = s3.upload(file, dest, { abortController });\n\n    const { url } = await promise;\n\n    // Fix Unicorn bug\n    return url.replace(/%2F/g, '/');\n  }\n\n  const acceptString = computed(() => {\n    if (Array.isArray(accept.value)) {\n      return accept.value.join(',');\n    }\n\n    return accept.value;\n  });\n\n  const acceptList = computed(() => {\n    if (Array.isArray(accept.value)) {\n      return accept.value;\n    }\n\n    return accept.value?.split(',').map(item => item.trim()) || [];\n  });\n\n  function checkFileType(file: File) {\n    if (acceptList.value.length === 0) {\n      return true;\n    }\n\n    return acceptList.value.some((accept) => {\n      if (accept.startsWith('.')) {\n        return file.name.endsWith(accept);\n      } else {\n        const regex = new RegExp('^' + accept.replace('*', '.*') + '$');\n        return regex.test(file.type);\n      }\n    });\n  }\n\n  function cancel() {\n    abortController?.abort();\n  }\n\n  return {\n    classicUpload,\n    wrapClassicUpload,\n    s3MultiPartUpload,\n    acceptString,\n    acceptList,\n    checkFileType,\n    cancel,\n  };\n}\n\n"],"names":["accept"],"mappings":";;AAYA,IAAI,kBAA0C;AAEvC,SAAS,gBAAgB,kBAAuC,IAAI;AACzE,QAAM,SAAS,MAAM,gBAAgB,MAAM;AAE3C,WAAS,kBACP,WACA,SACA;AACA,WAAO,OAAO,MAAY,SAAkB;AAC1C,aAAO,cAAc,WAAW,MAAM,MAAM,OAAO;AAAA,IACrD;AAAA,EACF;AAEA,iBAAe,cACb,WACA,MACA,MACA,SACA;AACA,UAAM,EAAE,SAAS,MAAM,cAAA;AAEvB,UAAM,WAAW,IAAI,SAAA;AACrB,aAAS,OAAO,QAAQ,IAAI;AAE5B,QAAI,MAAM;AACR,eAAS,OAAO,QAAQ,IAAI;AAAA,IAC9B;AAEA,UAAM,aAAa,SAAS,cAAc,gBAAgB;AAC1D,sBAAkB,IAAI,gBAAA;AAEtB,UAAM,MAAM,MAAM,KAAiC,WAAW,UAAU;AAAA,MACtE,QAAQ,gBAAgB;AAAA,MACxB,kBAAkB,CAAC,kBAAkB;AACnC,YAAI,cAAc,OAAO;AACvB,gBAAM,aAAa,KAAK,MAAO,cAAc,SAAS,MAAO,cAAc,KAAK;AAChF,uBAAa,UAAU;AAAA,QACzB;AAAA,MACF;AAAA,IAAA,CACD;AAED,WAAO,IAAI,KAAK,KAAK;AAAA,EACvB;AAEA,iBAAe,kBAAkB,MAAY,MAAc,SAA6B;AACtF,UAAM,aAAa,SAAS,cAAc,gBAAgB;AAE1D,UAAM,UAAU,KAAK,sBAAsB;AAC3C,UAAM,KAAK,MAAM,uBAAuB;AAAA,MACtC;AAAA,MACA,QAAQ,CAAC,WAAW;AAClB,eAAO,iBAAiB,MAAM;AAAA,MAChC;AAAA,MACA,YAAY,CAAC,MAAM;AACjB,qBAAa,EAAE,UAAU;AAAA,MAC3B;AAAA,IAAA,CACD;AAED,sBAAkB,IAAI,gBAAA;AAEtB,UAAM,UAAU,GAAG,OAAO,MAAM,MAAM,EAAE,iBAAiB;AAEzD,UAAM,EAAE,IAAA,IAAQ,MAAM;AAGtB,WAAO,IAAI,QAAQ,QAAQ,GAAG;AAAA,EAChC;AAEA,QAAM,eAAe,SAAS,MAAM;AAClC,QAAI,MAAM,QAAQ,OAAO,KAAK,GAAG;AAC/B,aAAO,OAAO,MAAM,KAAK,GAAG;AAAA,IAC9B;AAEA,WAAO,OAAO;AAAA,EAChB,CAAC;AAED,QAAM,aAAa,SAAS,MAAM;AAChC,QAAI,MAAM,QAAQ,OAAO,KAAK,GAAG;AAC/B,aAAO,OAAO;AAAA,IAChB;AAEA,WAAO,OAAO,OAAO,MAAM,GAAG,EAAE,IAAI,CAAA,SAAQ,KAAK,KAAA,CAAM,KAAK,CAAA;AAAA,EAC9D,CAAC;AAED,WAAS,cAAc,MAAY;AACjC,QAAI,WAAW,MAAM,WAAW,GAAG;AACjC,aAAO;AAAA,IACT;AAEA,WAAO,WAAW,MAAM,KAAK,CAACA,YAAW;AACvC,UAAIA,QAAO,WAAW,GAAG,GAAG;AAC1B,eAAO,KAAK,KAAK,SAASA,OAAM;AAAA,MAClC,OAAO;AACL,cAAM,QAAQ,IAAI,OAAO,MAAMA,QAAO,QAAQ,KAAK,IAAI,IAAI,GAAG;AAC9D,eAAO,MAAM,KAAK,KAAK,IAAI;AAAA,MAC7B;AAAA,IACF,CAAC;AAAA,EACH;AAEA,WAAS,SAAS;AAChB,qBAAiB,MAAA;AAAA,EACnB;AAEA,SAAO;AAAA,IACL;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EAAA;AAEJ;"}