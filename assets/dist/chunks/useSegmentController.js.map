{"version":3,"file":"useSegmentController.js","sources":["../../src/modules/segment-editor/features/segment/useSegmentController.ts"],"sourcesContent":["import { uniqueItem, useLoading } from '@lyrasoft/ts-toolkit/vue';\nimport { createGlobalState, useDebounceFn } from '@vueuse/core';\nimport { ApiReturn, route, useHttpClient } from '@windwalker-io/unicorn-next';\nimport { ref } from 'vue';\nimport { Segment } from '~melo/types';\n\nexport const useSegmentController = createGlobalState(() => {\n  const { loading: saving, wrap, run } = useLoading();\n\n  async function save(item: Segment, isNew: boolean = false) {\n    const { post } = await useHttpClient();\n\n    const res = await post<ApiReturn<Segment>>(\n      route('@ajax_segment/save'),\n      {\n        item,\n        isNew,\n      }\n    );\n\n    return res.data.data;\n  }\n\n  const reorder = useDebounceFn(async (segments: Segment[]) => {\n    return run(async () => {\n      const orders: Record<number, number> = {};\n\n      await disableAutoSave(() => {\n        for (const [i, item] of segments.entries()) {\n          item.ordering = orders[item.id as number] = i + 1;\n        }\n      });\n\n      const { post } = await useHttpClient();\n\n      const res = await post(\n        route('@ajax_segment/reorder'),\n        {\n          orders: orders,\n        }\n      );\n\n      return res.data.data;\n    });\n  }, 500);\n\n  async function remove(id: number) {\n    const { post } = await useHttpClient();\n\n    await post(\n      route('@ajax_segment/delete'),\n      {\n        id\n      }\n    );\n  }\n\n  function createEmptySectionItem(chapter: Segment, type: string) {\n    return uniqueItem<Segment>({\n      lessonId: chapter.lessonId,\n      parentId: chapter.id!,\n      type: type,\n      title: '',\n      content: '',\n      src: '',\n      filename: '',\n      ext: '',\n      captionSrc: '',\n      duration: 0,\n      can_skip: 0,\n      state: 1,\n      ordering: 0,\n      canSkip: false,\n      created: null,\n      createdBy: 0,\n      modified: null,\n      modifiedBy: 0,\n      params: undefined,\n      preview: false\n    });\n  }\n\n  function createEmptyChapterItem(lessonId: number) {\n    return uniqueItem<Segment>({\n      lessonId: lessonId,\n      parentId: 0,\n      type: '',\n      title: '',\n      content: '',\n      src: '',\n      filename: '',\n      ext: '',\n      captionSrc: '',\n      duration: 0,\n      can_skip: 0,\n      state: 1,\n      ordering: 0,\n      canSkip: false,\n      created: null,\n      createdBy: 0,\n      modified: null,\n      modifiedBy: 0,\n      params: undefined,\n      preview: false\n    });\n  }\n\n  // Save\n  const autoSave = ref(true);\n\n  async function disableAutoSave(handler: () => any) {\n    autoSave.value = false;\n\n    const r = await handler();\n\n    autoSave.value = true;\n\n    return r;\n  }\n\n  // Delete Files\n  async function deleteFile(url: string, id: number, field: string) {\n    const { delete: del } = await useHttpClient();\n\n    await del(\n      route('@ajax_segment/deleteFile'),\n      {\n        url,\n        id,\n        field\n      }\n    );\n  }\n\n  return {\n    autoSave,\n    saving,\n\n    save,\n    reorder,\n    remove,\n    createEmptyChapterItem,\n    createEmptySectionItem,\n    wrapSaving: wrap,\n    runSaving: run,\n    disableAutoSave,\n    deleteFile,\n  };\n});\n\n"],"names":[],"mappings":";;;;AAMO,MAAM,uBAAuB,kBAAkB,MAAM;AAC1D,QAAM,EAAE,SAAS,QAAQ,MAAM,IAAA,IAAQ,WAAA;AAEvC,iBAAe,KAAK,MAAe,QAAiB,OAAO;AACzD,UAAM,EAAE,SAAS,MAAM,cAAA;AAEvB,UAAM,MAAM,MAAM;AAAA,MAChB,MAAM,oBAAoB;AAAA,MAC1B;AAAA,QACE;AAAA,QACA;AAAA,MAAA;AAAA,IACF;AAGF,WAAO,IAAI,KAAK;AAAA,EAClB;AAEA,QAAM,UAAU,cAAc,OAAO,aAAwB;AAC3D,WAAO,IAAI,YAAY;AACrB,YAAM,SAAiC,CAAA;AAEvC,YAAM,gBAAgB,MAAM;AAC1B,mBAAW,CAAC,GAAG,IAAI,KAAK,SAAS,WAAW;AAC1C,eAAK,WAAW,OAAO,KAAK,EAAY,IAAI,IAAI;AAAA,QAClD;AAAA,MACF,CAAC;AAED,YAAM,EAAE,SAAS,MAAM,cAAA;AAEvB,YAAM,MAAM,MAAM;AAAA,QAChB,MAAM,uBAAuB;AAAA,QAC7B;AAAA,UACE;AAAA,QAAA;AAAA,MACF;AAGF,aAAO,IAAI,KAAK;AAAA,IAClB,CAAC;AAAA,EACH,GAAG,GAAG;AAEN,iBAAe,OAAO,IAAY;AAChC,UAAM,EAAE,SAAS,MAAM,cAAA;AAEvB,UAAM;AAAA,MACJ,MAAM,sBAAsB;AAAA,MAC5B;AAAA,QACE;AAAA,MAAA;AAAA,IACF;AAAA,EAEJ;AAEA,WAAS,uBAAuB,SAAkB,MAAc;AAC9D,WAAO,WAAoB;AAAA,MACzB,UAAU,QAAQ;AAAA,MAClB,UAAU,QAAQ;AAAA,MAClB;AAAA,MACA,OAAO;AAAA,MACP,SAAS;AAAA,MACT,KAAK;AAAA,MACL,UAAU;AAAA,MACV,KAAK;AAAA,MACL,YAAY;AAAA,MACZ,UAAU;AAAA,MACV,UAAU;AAAA,MACV,OAAO;AAAA,MACP,UAAU;AAAA,MACV,SAAS;AAAA,MACT,SAAS;AAAA,MACT,WAAW;AAAA,MACX,UAAU;AAAA,MACV,YAAY;AAAA,MACZ,QAAQ;AAAA,MACR,SAAS;AAAA,IAAA,CACV;AAAA,EACH;AAEA,WAAS,uBAAuB,UAAkB;AAChD,WAAO,WAAoB;AAAA,MACzB;AAAA,MACA,UAAU;AAAA,MACV,MAAM;AAAA,MACN,OAAO;AAAA,MACP,SAAS;AAAA,MACT,KAAK;AAAA,MACL,UAAU;AAAA,MACV,KAAK;AAAA,MACL,YAAY;AAAA,MACZ,UAAU;AAAA,MACV,UAAU;AAAA,MACV,OAAO;AAAA,MACP,UAAU;AAAA,MACV,SAAS;AAAA,MACT,SAAS;AAAA,MACT,WAAW;AAAA,MACX,UAAU;AAAA,MACV,YAAY;AAAA,MACZ,QAAQ;AAAA,MACR,SAAS;AAAA,IAAA,CACV;AAAA,EACH;AAGA,QAAM,WAAW,IAAI,IAAI;AAEzB,iBAAe,gBAAgB,SAAoB;AACjD,aAAS,QAAQ;AAEjB,UAAM,IAAI,MAAM,QAAA;AAEhB,aAAS,QAAQ;AAEjB,WAAO;AAAA,EACT;AAGA,iBAAe,WAAW,KAAa,IAAY,OAAe;AAChE,UAAM,EAAE,QAAQ,IAAA,IAAQ,MAAM,cAAA;AAE9B,UAAM;AAAA,MACJ,MAAM,0BAA0B;AAAA,MAChC;AAAA,QACE;AAAA,QACA;AAAA,QACA;AAAA,MAAA;AAAA,IACF;AAAA,EAEJ;AAEA,SAAO;AAAA,IACL;AAAA,IACA;AAAA,IAEA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA,YAAY;AAAA,IACZ,WAAW;AAAA,IACX;AAAA,IACA;AAAA,EAAA;AAEJ,CAAC;"}