{"version":3,"file":"useSegmentController.js","sources":["../../src/features/segment/useSegmentController.ts"],"sourcesContent":["import { uniqueItem, useLoading } from '@lyrasoft/ts-toolkit/vue';\r\nimport { createGlobalState, useDebounceFn } from '@vueuse/core';\r\nimport { ApiReturn, route, useHttpClient } from '@windwalker-io/unicorn-next';\r\nimport { ref } from 'vue';\r\nimport { Segment } from '~melo/types';\r\n\r\nexport const useSegmentController = createGlobalState(() => {\r\n  const { loading: saving, wrap, run } = useLoading();\r\n\r\n  async function save(item: Segment, isNew: boolean = false) {\r\n    const { post } = await useHttpClient();\r\n\r\n    const res = await post<ApiReturn<Segment>>(\r\n      route('@ajax_segment/save'),\r\n      {\r\n        item,\r\n        isNew,\r\n      }\r\n    );\r\n\r\n    return res.data.data;\r\n  }\r\n\r\n  const reorder = useDebounceFn(async (segments: Segment[]) => {\r\n    return run(async () => {\r\n      const orders: Record<number, number> = {};\r\n\r\n      await disableAutoSave(() => {\r\n        for (const [i, item] of segments.entries()) {\r\n          item.ordering = orders[item.id as number] = i + 1;\r\n        }\r\n      });\r\n\r\n      const { post } = await useHttpClient();\r\n\r\n      const res = await post(\r\n        route('@ajax_segment/reorder'),\r\n        {\r\n          orders: orders,\r\n        }\r\n      );\r\n\r\n      return res.data.data;\r\n    });\r\n  }, 500);\r\n\r\n  async function remove(id: number) {\r\n    const { post } = await useHttpClient();\r\n\r\n    await post(\r\n      route('@ajax_segment/delete'),\r\n      {\r\n        id\r\n      }\r\n    );\r\n  }\r\n\r\n  function createEmptySectionItem(chapter: Segment, type: string) {\r\n    return uniqueItem<Segment>({\r\n      lessonId: chapter.lessonId,\r\n      parentId: chapter.id!,\r\n      type: type,\r\n      title: '',\r\n      content: '',\r\n      src: '',\r\n      filename: '',\r\n      ext: '',\r\n      captionSrc: '',\r\n      duration: 0,\r\n      can_skip: 0,\r\n      state: 1,\r\n      ordering: 0,\r\n      canSkip: false,\r\n      created: null,\r\n      createdBy: 0,\r\n      modified: null,\r\n      modifiedBy: 0,\r\n      params: undefined,\r\n      preview: false\r\n    });\r\n  }\r\n\r\n  function createEmptyChapterItem(lessonId: number) {\r\n    return uniqueItem<Segment>({\r\n      lessonId: lessonId,\r\n      parentId: 0,\r\n      type: '',\r\n      title: '',\r\n      content: '',\r\n      src: '',\r\n      filename: '',\r\n      ext: '',\r\n      captionSrc: '',\r\n      duration: 0,\r\n      can_skip: 0,\r\n      state: 1,\r\n      ordering: 0,\r\n      canSkip: false,\r\n      created: null,\r\n      createdBy: 0,\r\n      modified: null,\r\n      modifiedBy: 0,\r\n      params: undefined,\r\n      preview: false\r\n    });\r\n  }\r\n\r\n  // Save\r\n  const autoSave = ref(true);\r\n\r\n  async function disableAutoSave(handler: () => any) {\r\n    autoSave.value = false;\r\n\r\n    const r = await handler();\r\n\r\n    autoSave.value = true;\r\n\r\n    return r;\r\n  }\r\n\r\n  // Delete Files\r\n  async function deleteFile(url: string, id: number, field: string) {\r\n    const { delete: del } = await useHttpClient();\r\n\r\n    await del(\r\n      route('@ajax_segment/deleteFile'),\r\n      {\r\n        url,\r\n        id,\r\n        field\r\n      }\r\n    );\r\n  }\r\n\r\n  return {\r\n    autoSave,\r\n    saving,\r\n\r\n    save,\r\n    reorder,\r\n    remove,\r\n    createEmptyChapterItem,\r\n    createEmptySectionItem,\r\n    wrapSaving: wrap,\r\n    runSaving: run,\r\n    disableAutoSave,\r\n    deleteFile,\r\n  };\r\n});\r\n\r\n"],"names":[],"mappings":";;;;AAMO,MAAM,uBAAuB,kBAAkB,MAAM;AAC1D,QAAM,EAAE,SAAS,QAAQ,MAAM,IAAA,IAAQ,WAAA;AAEvC,iBAAe,KAAK,MAAe,QAAiB,OAAO;AACzD,UAAM,EAAE,SAAS,MAAM,cAAA;AAEvB,UAAM,MAAM,MAAM;AAAA,MAChB,MAAM,oBAAoB;AAAA,MAC1B;AAAA,QACE;AAAA,QACA;AAAA,MAAA;AAAA,IACF;AAGF,WAAO,IAAI,KAAK;AAAA,EAClB;AAEA,QAAM,UAAU,cAAc,OAAO,aAAwB;AAC3D,WAAO,IAAI,YAAY;AACrB,YAAM,SAAiC,CAAA;AAEvC,YAAM,gBAAgB,MAAM;AAC1B,mBAAW,CAAC,GAAG,IAAI,KAAK,SAAS,WAAW;AAC1C,eAAK,WAAW,OAAO,KAAK,EAAY,IAAI,IAAI;AAAA,QAClD;AAAA,MACF,CAAC;AAED,YAAM,EAAE,SAAS,MAAM,cAAA;AAEvB,YAAM,MAAM,MAAM;AAAA,QAChB,MAAM,uBAAuB;AAAA,QAC7B;AAAA,UACE;AAAA,QAAA;AAAA,MACF;AAGF,aAAO,IAAI,KAAK;AAAA,IAClB,CAAC;AAAA,EACH,GAAG,GAAG;AAEN,iBAAe,OAAO,IAAY;AAChC,UAAM,EAAE,SAAS,MAAM,cAAA;AAEvB,UAAM;AAAA,MACJ,MAAM,sBAAsB;AAAA,MAC5B;AAAA,QACE;AAAA,MAAA;AAAA,IACF;AAAA,EAEJ;AAEA,WAAS,uBAAuB,SAAkB,MAAc;AAC9D,WAAO,WAAoB;AAAA,MACzB,UAAU,QAAQ;AAAA,MAClB,UAAU,QAAQ;AAAA,MAClB;AAAA,MACA,OAAO;AAAA,MACP,SAAS;AAAA,MACT,KAAK;AAAA,MACL,UAAU;AAAA,MACV,KAAK;AAAA,MACL,YAAY;AAAA,MACZ,UAAU;AAAA,MACV,UAAU;AAAA,MACV,OAAO;AAAA,MACP,UAAU;AAAA,MACV,SAAS;AAAA,MACT,SAAS;AAAA,MACT,WAAW;AAAA,MACX,UAAU;AAAA,MACV,YAAY;AAAA,MACZ,QAAQ;AAAA,MACR,SAAS;AAAA,IAAA,CACV;AAAA,EACH;AAEA,WAAS,uBAAuB,UAAkB;AAChD,WAAO,WAAoB;AAAA,MACzB;AAAA,MACA,UAAU;AAAA,MACV,MAAM;AAAA,MACN,OAAO;AAAA,MACP,SAAS;AAAA,MACT,KAAK;AAAA,MACL,UAAU;AAAA,MACV,KAAK;AAAA,MACL,YAAY;AAAA,MACZ,UAAU;AAAA,MACV,UAAU;AAAA,MACV,OAAO;AAAA,MACP,UAAU;AAAA,MACV,SAAS;AAAA,MACT,SAAS;AAAA,MACT,WAAW;AAAA,MACX,UAAU;AAAA,MACV,YAAY;AAAA,MACZ,QAAQ;AAAA,MACR,SAAS;AAAA,IAAA,CACV;AAAA,EACH;AAGA,QAAM,WAAW,IAAI,IAAI;AAEzB,iBAAe,gBAAgB,SAAoB;AACjD,aAAS,QAAQ;AAEjB,UAAM,IAAI,MAAM,QAAA;AAEhB,aAAS,QAAQ;AAEjB,WAAO;AAAA,EACT;AAGA,iBAAe,WAAW,KAAa,IAAY,OAAe;AAChE,UAAM,EAAE,QAAQ,IAAA,IAAQ,MAAM,cAAA;AAE9B,UAAM;AAAA,MACJ,MAAM,0BAA0B;AAAA,MAChC;AAAA,QACE;AAAA,QACA;AAAA,QACA;AAAA,MAAA;AAAA,IACF;AAAA,EAEJ;AAEA,SAAO;AAAA,IACL;AAAA,IACA;AAAA,IAEA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA,YAAY;AAAA,IACZ,WAAW;AAAA,IACX;AAAA,IACA;AAAA,EAAA;AAEJ,CAAC;"}