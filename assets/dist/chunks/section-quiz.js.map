{"version":3,"file":"section-quiz.js","sources":["../../src/modules/section-quiz/useQuestionFrontComponents.ts","../../src/modules/section-quiz/SectionQuizApp.vue","../../src/modules/section-quiz/section-quiz.ts"],"sourcesContent":["\ntype ModuleImportCallback = () => Promise<any>;\n\nconst questionFrontComponents: Record<string, ModuleImportCallback> = {\n  boolean: () => import('~melo/modules/section-quiz/BasicQuestionProcessing.vue'),\n  select: () => import('~melo/modules/section-quiz/BasicQuestionProcessing.vue'),\n  multiple: () => import('~melo/modules/section-quiz/BasicQuestionProcessing.vue'),\n}\n\nexport function useQuestionFrontComponents(): Record<string, ModuleImportCallback>;\nexport function useQuestionFrontComponents(id: string, component: ModuleImportCallback): Record<string, ModuleImportCallback>;\nexport function useQuestionFrontComponents(id: Record<string, ModuleImportCallback>): Record<string, ModuleImportCallback>;\nexport function useQuestionFrontComponents(id?: string | Record<string, ModuleImportCallback>, component?: ModuleImportCallback) {\n  if (typeof id === 'object') {\n    Object.assign(questionFrontComponents, id);\n  } else if (component && typeof id === 'string') {\n    questionFrontComponents[id] = component;\n  }\n\n  return questionFrontComponents;\n}\n\n","<script setup lang=\"ts\">\n\nimport { useLoading } from '@lyrasoft/ts-toolkit/vue';\nimport { animateTo, ApiReturn, simpleAlert, sleep, useHttpClient } from '@windwalker-io/unicorn-next';\nimport { Modal } from 'bootstrap';\nimport { computed, defineAsyncComponent, onMounted, ref, useTemplateRef } from 'vue';\nimport { useQuestionFrontComponents } from '~melo/modules/section-quiz/useQuestionFrontComponents';\nimport { useQuestionPresenter } from '~melo/modules/segment-editor/features/question/useQuestionPresenter';\nimport { Question, QuestionDefine, Segment } from '~melo/types';\n\nconst props = defineProps<{\n  questionDefines: Record<string, QuestionDefine>;\n}>();\n\nconst { provideDefines } = useQuestionPresenter();\n\nprovideDefines(props.questionDefines);\n\nconst modalEl = useTemplateRef<HTMLDivElement>('modalEl');\nlet modal: Modal;\nconst chapterIndex = ref(0);\nconst sectionIndex = ref(0);\nconst typeIndex = ref(0);\nconst segmentId = ref(0);\nconst segmentTitle = ref('');\nconst currentSegment = ref<Segment>();\nconst loaded = ref(false);\n\nonMounted(() => {\n  modal = Modal.getOrCreateInstance(modalEl.value!);\n\n  const buttons = document.querySelectorAll<HTMLAnchorElement>('[data-task=\"start-quiz\"]');\n\n  for (const button of buttons) {\n    button.addEventListener('click', async (e) => {\n      e.preventDefault();\n\n      if (\n        button.getAttribute('disabled') != null\n        || button.classList.contains('disabled')\n        || button.getAttribute('aria-disabled') === 'true'\n      ) {\n        return;\n      }\n\n      loaded.value = false;\n\n      await startQuiz(button);\n\n      loaded.value = true;\n\n      modal.show();\n    });\n  }\n});\n\nconst form = useTemplateRef<HTMLFormElement>('form');\nconst questions = ref<Question[]>([]);\n\nasync function startQuiz(button: HTMLAnchorElement) {\n  segmentId.value = Number(button.dataset.segmentId);\n  segmentTitle.value = button.dataset.segmentTitle || '';\n  chapterIndex.value = Number(button.dataset.chapterIndex) || 0;\n  sectionIndex.value = Number(button.dataset.sectionIndex) || 0;\n  typeIndex.value = Number(button.dataset.typeIndex) || 0;\n\n  const { get } = await useHttpClient();\n\n  const res = await get<ApiReturn<{ questions: Question[]; }>>(\n    `@ajax_lesson/prepareQuestionList?id=${segmentId.value}`\n  );\n\n  questions.value = res.data.data.questions;\n\n  for (const question of questions.value) {\n    answers.value[question.id as number] = null;\n  }\n}\n\n// Answers\nconst answers = ref<Record<number, any>>({});\n\n// Questions\nconst questionComponents = computed(() => {\n  const components: Record<number, any> = {};\n\n  for (const i in questions.value) {\n    const qn = questions.value[i];\n    const loader = getQuestionComponent(qn);\n\n    if (!loader) {\n      continue;\n    }\n\n    components[qn.id as number] = loader;\n  }\n\n  return components;\n});\n\nfunction getQuestionComponent(question: Question) {\n  const components = useQuestionFrontComponents();\n\n  const component = components[question.type];\n\n  if (!component) {\n    return null;\n  }\n\n  return defineAsyncComponent(component);\n}\n\n// Submit\nconst { loading, wrap } = useLoading();\n\nasync function alertUnAnswerQuestion(id: string) {\n  const index = questions.value.findIndex((qn) => Number(qn.id) === Number(id));\n\n  await simpleAlert(`第 ${index + 1} 題尚未作答！`, '', 'warning');\n\n  const qnContainer = modalEl.value!.querySelector('.c-question-list');\n\n  const qnBox = qnContainer?.children[index] as HTMLDivElement;\n\n  if (qnBox) {\n    qnBox.scrollIntoView({ behavior: 'smooth', block: 'center' });\n    qnBox.style.transition = 'all .75s ease-in-out';\n\n    await sleep(500);\n    qnBox.style.borderColor = 'var(--bs-danger)';\n    await sleep(1250);\n    qnBox.style.borderColor = '';\n  }\n}\n\nconst submit = wrap(async () => {\n  const { post } = await useHttpClient();\n\n  for (const id in answers.value) {\n    const ans = answers.value[id];\n\n    if (ans === '' || ans == null || (Array.isArray(ans) && ans.length === 0)) {\n      alertUnAnswerQuestion(id);\n      return;\n    }\n  }\n\n  const formData = new FormData(form.value!);\n\n  try {\n    await post(\n      '@ajax_lesson/submitQuiz',\n      formData,\n    );\n\n    await simpleAlert('測驗提交成功！', '', 'success');\n\n    location.reload();\n  } catch (e) {\n    console.error(e);\n\n    if (e instanceof Error) {\n      simpleAlert('測驗提交失敗！', e.message, 'warning');\n    }\n  }\n});\n</script>\n\n<template>\n  <div>\n    <div ref=\"modalEl\" class=\"modal fade c-quiz-modal\" id=\"quiz-modal\" tabindex=\"-1\" aria-hidden=\"true\">\n      <div class=\"modal-dialog modal-lg\">\n        <div class=\"modal-content\">\n          <div class=\"modal-header\">\n            <h4 class=\"modal-title\">\n              測驗\n            </h4>\n            <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\" aria-label=\"Close\"></button>\n          </div>\n\n          <div class=\"modal-body px-5 mx-5\">\n            <form ref=\"form\" id=\"quiz-form\" enctype=\"multipart/form-data\" method=\"post\">\n              <div class=\"my-4 text-muted text-center j-quiz-title\">\n              </div>\n\n              <div class=\"text-danger mb-5 text-center\">\n                ＊提醒您未完成此測驗無法前往下個章節唷！\n              </div>\n\n              <div v-if=\"loaded\" class=\"c-question-list mb-4 d-flex flex-column gap-4\">\n                <div class=\"card c-question-item-wrapper\" v-for=\"(question, index) in questions\" :key=\"question.id\">\n                  <Component\n                    class=\"card-body\"\n                    :is=\"questionComponents[question.id as number]\"\n                    :index=\"index + 1\"\n                    :question=\"question\"\n                    v-model=\"answers[question.id as number]\"\n                  />\n                </div>\n              </div>\n\n              <div class=\"text-danger text-center mb-5\">\n                ＊提交後無法變更答案唷！\n              </div>\n\n              <input type=\"hidden\" class=\"j-quiz-section-id\" name=\"segment_id\" :value=\"segmentId\">\n\n              <div class=\"text-center mb-5\">\n                <button type=\"button\" class=\"btn btn-primary btn-lg j-quiz-submit w-100\"\n                  :disabled=\"loading\"\n                  @click=\"submit\"\n                >\n                  提交\n                </button>\n              </div>\n            </form>\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n</template>\n\n<style scoped>\n\n</style>\n","import { createApp } from 'vue';\nimport SectionQuizApp from '~melo/modules/section-quiz/SectionQuizApp.vue';\n\nexport async function createSectionQuizApp(props: Record<string, any> = {}) {\n  const app = createApp(SectionQuizApp, props);\n\n  return app;\n}\n\n"],"names":["_createElementBlock","_createElementVNode","_createTextVNode","_openBlock","_Fragment","_renderList","_createBlock","_resolveDynamicComponent"],"mappings":"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"}